<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />

    <title>LoAM - 내 캐릭터</title>

    <!-- Global Style and Script -->
    <link rel="stylesheet" href="./globalStyle.css" />
    <script type="module" src="./globalScript.js"></script>

    <!-- Page Style and Script -->
    <link rel="stylesheet" href="./css/my-characters.css" />

  </head>
  <body>
    <div id="includedHeaderWrapper"><!-- include by layout.js --></div>

    <div id="pageContentWrapper">
      <div id="myCharactersPage" class="medium-container">
        <div class="page-title">
          내 캐릭터
        </div>

        <section class="card-section">
          <div class="card-section-title">
            추가하기
          </div>
          <div class="add-character-form">
            <input
              type="text"
              placeholder="닉네임 입력"
              class="input"
              id="characterNicknameInput"
              spellcheck="false"
            />
            <button
              type="button"
              class="button"
              id="addCharacterButton"
            >
              추가
            </button>
          </div>
        </section>

        <section class="card-section">
          <div class="card-section-title">
            목록 <span class="character-count">0</span>
          </div>

          <div id="myCharacterList"></div>
        </section>

        <div id="loading"></div>
      </div>
    </div>

    <div id="includedFooterWrapper"><!-- include by layout.js --></div>

    <!-- Page Script -->
    <script type="module">
      import { api, snackbar, utils, data } from './lib/stdlib.js';
      import Drag from './modules/drag.js';

      const $loading = document.getElementById('loading');
      const $myCharacterList = document.getElementById('myCharacterList');
      const $characterNicknameInput = document.getElementById('characterNicknameInput');
      const $addCharacterButton = document.getElementById('addCharacterButton');

      // 사용할 로딩 엘리먼트 추가
      utils.addLoadingElement($loading, 'fixed');

      // Draggable 추가
      const drag = new Drag();
      drag.setupOptions({
        containerElm: $myCharacterList,
        handleElmClassName: 'character-item-drag-handle'
      });
      drag.init();

      // 리스트 출력
      showMyCharacterList();

      function showMyCharacterList() {
        const _myCharacters = data.getMyCharacters();
        _myCharacters.forEach(item => {
          addMyCharacterRowElement(item.nickname, item.classname, item.level);
        });
      }

      function addMyCharacterRowElement(nickname, classname, level) {
        const $mainElm = document.createElement('div');
        $mainElm.classList.add('character-item');

        // event가 없는 element라서 insertAdjacentHTML 사용
        $mainElm.insertAdjacentHTML(
          'afterbegin',
          `
            <a class="character-info-panel" href="/character-info.html?nickname=${nickname}">
              <div class="character-level">${utils.getLevelInteger(level)}</div>
              <div class="character-nickname-panel">
                <div class="character-class">${classname}</div>
                <div class="character-nickname">${nickname}</div>
              </div>
            </a>
          `
        )

        // event가 있는 element라서 createElement 사용
        const $actionPanelElm = document.createElement('div');
        $actionPanelElm.classList.add('character-action-panel');

        const $dragHandleBtnElm = document.createElement('button');
        $dragHandleBtnElm.classList.add('character-action-btn', 'character-item-drag-handle');

        const $dragHandleIconElm = document.createElement('i');
        $dragHandleIconElm.classList.add('fa-solid', 'fa-arrows-up-down');

        $dragHandleBtnElm.appendChild($dragHandleIconElm);

        const $deleteBtnElm = document.createElement('button');
        $deleteBtnElm.classList.add('character-action-btn');
        $deleteBtnElm.addEventListener('click', deleteRow);

        const $deleteIconElm = document.createElement('i');
        $deleteIconElm.classList.add('fa-solid', 'fa-trash');

        $deleteBtnElm.appendChild($deleteIconElm);

        $actionPanelElm.append($dragHandleBtnElm, $deleteBtnElm);
        $mainElm.append($actionPanelElm);

        $myCharacterList.appendChild($mainElm);
      }


      // TODO
      function deleteRow() {
        console.log('삭제')
      }

      // form 제어
      $characterNicknameInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          submitCharacterNickname();
        }
      });

      $addCharacterButton.addEventListener('click', () => {
        submitCharacterNickname();
      });

      async function submitCharacterNickname() {
        // 입력값이 없으면 실행하지 않음
        const nickname = $characterNicknameInput.value.trim();
        if (nickname.length === 0) return;

        // 기존에 있는 캐릭터라면 실행하지 않음
        const _myCharacters = data.getMyCharacters();
        const dataByNickname = _myCharacters.find(item => item.nickname === nickname);
        if (dataByNickname !== undefined) {
          snackbar.error('이미 추가된 캐릭터입니다.');
          return
        }

        utils.showElement($loading);

        try {
          const chracterInfo = await api.getCharacterInfoByNickname(nickname);
          if (chracterInfo === null) {
            snackbar.error('캐릭터가 없습니다. 닉네임을 확인해 주세요.');
            return;
          }

          $characterNicknameInput.value = '';

          const _nickname = chracterInfo.ArmoryProfile.CharacterName;
          const _classname = chracterInfo.ArmoryProfile.CharacterClassName;
          const _level = chracterInfo.ArmoryProfile.ItemMaxLevel;
          data.addMyCharacter(_nickname, _classname, _level);
          addMyCharacterRowElement(_nickname, _classname, _level);

        } catch (error) {
          console.error('submitCharacterNickname', error);
          snackbar.error('캐릭터 추가에 실패하였습니다.');

        } finally {
          utils.hideElement($loading);
        }
      }

    </script>

  </body>
</html>