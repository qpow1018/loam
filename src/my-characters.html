<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />

    <title>LoAM - 내 캐릭터</title>

    <!-- Global Style and Script -->
    <link rel="stylesheet" href="./globalStyle.css" />
    <script type="module" src="./globalScript.js"></script>

    <!-- Page Style -->
    <link rel="stylesheet" href="./css/my-characters.css" />

  </head>
  <body>
    <div id="includedHeaderWrapper"><!-- include by layout.js --></div>

    <div id="pageContentWrapper">
      <div class="medium-container">
        <div class="page-title">
          내 캐릭터
        </div>

        <section class="card-section">
          <div class="card-section-title">
            추가하기
          </div>
          <div class="add-character-form">
            <input
              type="text"
              placeholder="닉네임 입력"
              class="input"
              id="characterNicknameInput"
              spellcheck="false"
            />
            <button
              type="button"
              class="button"
              id="addCharacterButton"
            >
              추가
            </button>
          </div>
        </section>

        <section class="card-section">
          <div class="card-section-title">
            목록 <span class="character-count">0</span>
          </div>

          <div id="myCharacterList"></div>
        </section>

        <div id="loading"></div>

        <div
          id="deleteMyCharacterModal"
          class="modal"
        >
          <div class="modal-title-panel">
            <div class="modal-title">캐릭터 삭제하기</div>
            <button class="modal-close-button">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="modal-content">
            <div class="modal-content-text">
              해당 캐릭터를 삭제하시겠습니까?
            </div>
            <div class="modal-content-action-box">
              <button
                type="button"
                class="button modal-action-btn modal-close-button"
              >
                취소
              </button>
              <button
                type="button"
                class="button button-red modal-action-btn delete-character-btn"
              >
                삭제하기
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="includedFooterWrapper"><!-- include by layout.js --></div>

    <!-- Page Script -->
    <script type="module">
      import { api, snackbar, modal, utils, data } from './lib/stdlib.js';
      import Drag from './modules/drag.js';

      const $loading = document.getElementById('loading');
      const $myCharacterList = document.getElementById('myCharacterList');
      const $characterNicknameInput = document.getElementById('characterNicknameInput');
      const $addCharacterButton = document.getElementById('addCharacterButton');
      const $deleteModalCloseButtonInHeader = document.querySelector('#deleteMyCharacterModal .modal-title-panel .modal-close-button');
      const $deleteModalCloseButtonInContent = document.querySelector('#deleteMyCharacterModal .modal-content-action-box .modal-close-button');
      const $deleteCharacterButton = document.querySelector('#deleteMyCharacterModal .modal-content-action-box .delete-character-btn');

      // 사용할 로딩 엘리먼트 추가
      utils.addLoadingElement($loading, 'fixed');

      // Draggable 추가
      const drag = new Drag();
      drag.setupOptions({
        containerElm: $myCharacterList,
        handleElmClassName: 'character-item-drag-handle',
        direction: 'y',
        onChange: handleChangeCharacterOrder
      });
      drag.init();

      function handleChangeCharacterOrder() {
        const newList = [];

        document.querySelectorAll('.character-item').forEach(item => {
          const nickname = item.getAttribute('data-nickname');
          const classname = item.getAttribute('data-classname');
          const level = item.getAttribute('data-level');
          newList.push({ nickname, classname, level })
        });

        data.setMyCharacters(newList);
      }

      // 리스트 출력
      showMyCharacterList();

      function showMyCharacterList() {
        const _myCharacters = data.getMyCharacters();
        _myCharacters.forEach(item => {
          addMyCharacterRowElement(item.nickname, item.classname, item.level);
        });
      }

      function addMyCharacterRowElement(nickname, classname, level) {
        const $mainElm = document.createElement('div');
        $mainElm.classList.add('character-item');

        $mainElm.setAttribute('data-nickname', nickname);
        $mainElm.setAttribute('data-classname', classname);
        $mainElm.setAttribute('data-level', level);

        // event가 없는 element라서 insertAdjacentHTML 사용
        $mainElm.insertAdjacentHTML(
          'afterbegin',
          `
            <a class="character-info-panel" href="/character-info.html?nickname=${nickname}">
              <div class="character-level">${utils.getLevelInteger(level)}</div>
              <div class="character-nickname-panel">
                <div class="character-class">${classname}</div>
                <div class="character-nickname">${nickname}</div>
              </div>
            </a>
          `
        )

        // event가 있는 element라서 createElement 사용
        const $actionPanelElm = document.createElement('div');
        $actionPanelElm.classList.add('character-action-panel');

        const $dragHandleBtnElm = document.createElement('button');
        $dragHandleBtnElm.classList.add('character-action-btn', 'character-item-drag-handle');

        const $dragHandleIconElm = document.createElement('i');
        $dragHandleIconElm.classList.add('fa-solid', 'fa-arrows-up-down');

        $dragHandleBtnElm.appendChild($dragHandleIconElm);

        const $deleteBtnElm = document.createElement('button');
        $deleteBtnElm.classList.add('character-action-btn');
        $deleteBtnElm.addEventListener('click', () => openDeleteMyCharacterModal(nickname));

        const $deleteIconElm = document.createElement('i');
        $deleteIconElm.classList.add('fa-solid', 'fa-trash');

        $deleteBtnElm.appendChild($deleteIconElm);

        $actionPanelElm.append($dragHandleBtnElm, $deleteBtnElm);
        $mainElm.append($actionPanelElm);

        $myCharacterList.appendChild($mainElm);
      }

      // 삭제 관련
      let deleteTargetNickname = null;

      $deleteModalCloseButtonInHeader.addEventListener('click', closeDeleteMyCharacterModal);
      $deleteModalCloseButtonInContent.addEventListener('click', closeDeleteMyCharacterModal);
      $deleteCharacterButton.addEventListener('click', deleteMyCharacter);

      function openDeleteMyCharacterModal(nickname) {
        deleteTargetNickname = nickname;
        modal.openWithId('deleteMyCharacterModal');
      }
      function closeDeleteMyCharacterModal() {
        deleteTargetNickname = null;
        modal.closeWithId('deleteMyCharacterModal');
      }

      function deleteMyCharacter(e) {
        if (deleteTargetNickname === null) return;

        data.deleteMyCharacter(deleteTargetNickname);
        const $deleteTargetElm = document.querySelector(`.character-item[data-nickname="${deleteTargetNickname}"]`);
        $deleteTargetElm.remove();

        closeDeleteMyCharacterModal();
      }

      // form 관련
      $characterNicknameInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          submitCharacterNickname();
        }
      });

      $addCharacterButton.addEventListener('click', () => {
        submitCharacterNickname();
      });

      async function submitCharacterNickname() {
        // 입력값이 없으면 실행하지 않음
        const nickname = $characterNicknameInput.value.trim();
        if (nickname.length === 0) return;

        // 기존에 있는 캐릭터라면 실행하지 않음
        const _myCharacters = data.getMyCharacters();
        const dataByNickname = _myCharacters.find(item => item.nickname === nickname);
        if (dataByNickname !== undefined) {
          snackbar.error('이미 추가된 캐릭터입니다.');
          return
        }

        utils.showElement($loading);

        try {
          const chracterInfo = await api.getCharacterInfoByNickname(nickname);
          if (chracterInfo === null) {
            snackbar.error('캐릭터가 없습니다. 닉네임을 확인해 주세요.');
            return;
          }

          $characterNicknameInput.value = '';

          const _nickname = chracterInfo.ArmoryProfile.CharacterName;
          const _classname = chracterInfo.ArmoryProfile.CharacterClassName;
          const _level = chracterInfo.ArmoryProfile.ItemMaxLevel;
          data.addMyCharacter(_nickname, _classname, _level);
          addMyCharacterRowElement(_nickname, _classname, _level);

        } catch (error) {
          console.error('submitCharacterNickname', error);
          snackbar.error('캐릭터 추가에 실패하였습니다.');

        } finally {
          utils.hideElement($loading);
        }
      }

    </script>

  </body>
</html>